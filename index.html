<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PowerPoint知識問題集 v2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans JP', 'Inter', sans-serif; background-color: #f0f4f8; padding: 20px; }
    .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px_12px rgba(0,0,0,0.08); max-width: 650px; margin: auto; }
    button, select { margin-top: 12px; padding: 12px; font-size: 16px; width: 100%; border-radius: 8px; border: 1px solid #d1d5db; transition: all 0.2s ease-in-out; }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    button:disabled { background-color: #d1d5db; cursor: not-allowed; }
    .small { font-size: 14px; color: #4b5563; }
    hr { margin: 24px 0; border-color: #e5e7eb; }
    .dialog-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; animation: fadeIn 0.3s forwards; }
    .dialog { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 90%; width: 500px; max-height: 80%; overflow-y: auto; transform: scale(0.95); animation: zoomIn 0.3s forwards; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s ease infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { to { opacity: 1; } }
    @keyframes zoomIn { to { transform: scale(1); } }
    /* Calendar Styles */
    #calendar { font-size: 14px; }
    #calendar th, #calendar td { text-align: center; padding: 8px; }
    #calendar td.today { background-color: #fef3c7; border-radius: 50%; }
    #calendar td.studied { background-color: #93c5fd; color: white; border-radius: 50%; font-weight: bold; }
  </style>
</head>
<body>
  <div class="card" id="app">
    <!-- Main content will be rendered here -->
  </div>

  <div id="userIdFooter" class="text-center text-xs text-gray-400 mt-4"></div>
  
  <script>
    // --- DATA ---
    const chapters = {
      "1. 作業環境、環境の設定と変更": [
        { question: "PowerPointのアプリケーションウィンドウの左上に表示される、よく使うコマンドを登録できる領域の名称はどれですか。", options: ["ステータスバー", "ミニツールバー", "クイックアクセスツールバー"], answer: 2, explanation: "ウィンドウの左上に表示されるのは「クイックアクセスツールバー」です。コマンドを自由に追加・削除できます。" },
        { question: "リボンの右端に表示されている「^」アイコンをクリックするとどうなりますか。", options: ["アプリケーションウィンドウが最小化される", "リボンが折りたたまれ、タブのみが表示される", "タッチパネル用にコマンドが拡大する"], answer: 1, explanation: "このアイコンをクリックすると、リボンが折りたたまれ、タブのみの表示になり、作業領域を広く使えます。" },
        { question: "[表示]タブの[プレゼンテーションの表示]グループにあるどの表示方法で、スライドペインの左側にスライドのテキストのみを表示できますか。", options: ["[標準]", "[アウトライン表示]", "[スライド一覧]"], answer: 1, explanation: "[アウトライン表示]を選択すると、スライド内のテキストが階層構造で表示され、文章全体の構成を確認・編集しやすくなります。" },
        { question: "ウィンドウ下部に表示される、スライド番号やノート、ズームスライダーなどがある領域は「ステータスバー」である。", options: ["正しい", "誤り"], answer: 0, explanation: "その通りです。ステータスバーは現在の状態を表示し、表示モードの切り替えなども行えます。" },
        { question: "水平ルーラーの目盛の単位は、任意に設定することができる。", options: ["正しい", "誤り"], answer: 1, explanation: "PowerPointのルーラーの単位は、OSの地域設定に依存し、通常はセンチメートルに固定されており、アプリ内で任意に変更することはできません。" },
        { question: "クイックアクセスツールバーをリボンの下に表示することができる。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。クイックアクセスツールバーの右端の▼から「リボンの下に表示」を選択して、位置を変更できます。" },
        { question: "[PowerPointのオプション]ダイアログボックスの[詳細設定]で、元に戻すことができる操作の最大数を設定できる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、[編集オプション]セクションで「元に戻す操作の最大数」を調整することが可能です。" },
        { question: "[PowerPointのオプション]ダイアログボックスの[詳細設定]で、スライドショーの最後に黒いスライドを表示するかどうかを設定できる。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。[スライドショー]セクションの「最後のスライドは黒にする」チェックボックスで設定します。" },
        { question: "[PowerPointのオプション]ダイアログボックスの[リボンのユーザー設定]を使用して、ユーザー設定のタブおよびグループを追加できる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、自分だけのオリジナルタブやグループを作成し、よく使うコマンドをまとめて配置することが可能です。" }
      ],
      "2. 書式設定": [
        { question: "選択したテキストのフォントサイズを1段階小さくするボタンはどれですか。", options: ["A▲", "A▼", "Aa"], answer: 1, explanation: "「A▼」のアイコンがフォントサイズを縮小するボタンです。" },
        { question: "水平ルーラーで、2行目以降が1行目より字下げされるインデント設定はどれですか。", options: ["字下げインデント", "ぶら下げインデント", "タブ"], answer: 1, explanation: "2行目以降の開始位置を調整するのは「ぶら下げインデント」です。箇条書きのテキストなどで使用されます。" },
        { question: "テキストボックス内の文字列「Office2019」全体に影を設定するには、どの状態で[ホーム]タブの[S]ボタンをクリックしますか。", options: ["テキストの左端にカーソルを置く", "テキストの右端にカーソルを置く", "テキストボックスの枠線をクリックして選択する"], answer: 2, explanation: "テキストボックスの枠線をクリックして実線表示にすると、ボックス内のテキスト全体に書式が適用されます。" },
        { question: "小数点以下の桁数が異なる数値を、小数点の位置で揃えて入力するには、どのタブ揃えを使用しますか。", options: ["中央揃えタブ", "右揃えタブ", "小数点揃えタブ"], answer: 2, explanation: "「小数点揃えタブ」を使用すると、数値の小数点の位置が垂直に揃い、見やすくなります。" },
        { question: "文字列の間隔を「広く」や「より広く」のように調整するボタンはどれですか。", options: ["AV↔", "≡", "A ↔"], answer: 0, explanation: "「AV↔」(文字間隔の調整)ボタンで、文字と文字の間のスペースを調整できます。" },
        { question: "水平ルーラー上で、タブ位置を変更するために移動するマーカーはどれですか。", options: ["△ (上向き三角)", "▽ (下向き三角)", "└ (L字)"], answer: 2, explanation: "「└」のようなタブマーカーをルーラー上でドラッグすることで、タブの位置を自由に変更できます。" },
        { question: "[箇条書きと段落番号]ダイアログボックスの[段落番号]タブで、開始番号を「0」に設定できる。", options: ["正しい", "誤り"], answer: 1, explanation: "段落番号の開始番号は、1から32767までの整数で設定する必要があり、0は設定できません。" },
        { question: "化学式「H₂O」のように数字を小さく下に表示する書式は「上付き」である。", options: ["正しい", "誤り"], answer: 1, explanation: "下に小さく表示するのは「下付き」です。「上付き」は累乗の指数などで使われます。" },
        { question: "斜体が設定されているテキストを選択し、[ホーム]タブの[I]ボタンをクリックすると、斜体が解除される。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、書式設定ボタンはトグル式になっており、再度クリックするとその書式が解除されます。" },
        { question: "[ホーム]タブの[Aa]ボタンを使用して、選択したテキストボックス内の英単語の先頭文字を大文字に変換できる。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。「文の先頭文字を大文字にする」「すべて大文字」など、複数の変換が可能です。" },
        { question: "[箇条書きと段落番号]ダイアログボックスで、行頭文字を「・」からアルファベットの「A), B), C)」に変更できる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、[段落番号]タブで様々な形式の番号や記号を選択できます。" },
        { question: "プレースホルダー内のテキストを選択し、[ホーム]タブの[両端揃え]ボタンをクリックすると、各行の文字が均等に配置される。", options: ["正しい", "誤り"], answer: 1, explanation: "両端揃えは、最終行を除く各行の左右の端を揃える機能です。文字を均等に配置するのは「均等割り付け」です。" },
        { question: "[ホーム]タブの[A] (フォントの色)ボタンで表示されるカラーパレットは、スライドに設定されているデザインテーマによって異なる。", options: ["正しい", "誤り"], answer: 0, explanation: "その通りです。テーマカラーに沿った配色が優先的に表示され、デザインに一貫性を持たせやすくなっています。" }
      ],
      "3. スライド": [
        { question: "[デザイン]タブの[バリエーション]にある[配色]を使用して、ユーザー定義の配色パターンを作成できる。", options: ["はい、作成できる", "いいえ、できない", "テーマによる"], answer: 0, explanation: "はい、[色のカスタマイズ]から独自の配色セットを作成し、保存することができます。" },
        { question: "テーマ「オーガニック」を適用したスライドで、[背景の書式設定]の「背景グラフィックを表示しない」をONにすると、背景の木目と帯の両方が非表示になる。", options: ["木目の背景のみ非表示", "帯と白い長方形のみ非表示", "両方とも非表示"], answer: 1, explanation: "背景グラフィックは、テーマによってデザインされた図形や模様を指します。この場合、帯と長方形が非表示になります。" },
        { question: "スライドショーの実行中に、1つ前のスライドに戻るキーはどれですか。", options: ["BackSpaceキー", "Escキー", "Shift+Tabキー"], answer: 0, explanation: "BackSpaceキー、または「←」キーや「↑」キーで前のスライドに戻ることができます。Escキーはスライドショーを終了します。" },
        { question: "目的別スライドショーで、表示するスライドの順番を定義した場合、スライドショーではどのスライドが最初に表示されますか。", options: ["プレゼンテーション中のスライドの1枚目", "目的別スライドショーのスライドの1枚目", "常にスライド番号1のスライド"], answer: 1, explanation: "目的別スライドショーでは、定義したリストの順番でスライドが表示されます。" },
        { question: "スライドショーで、画面が切り替わるタイミングでサウンドを再生するには、どこで設定しますか。", options: ["[デザイン]タブの「効果」", "[画面切り替え]タブの「サウンド」", "[スライドショー]タブの「ナレーションの再生」"], answer: 1, explanation: "[画面切り替え]タブにある[サウンド]ドロップダウンリストから設定します。" },
        { question: "最初のスライドからスライドショーを実行するショートカットキーはどれですか。", options: ["F4", "F5", "F6"], answer: 1, explanation: "F5キーを押すと、プレゼンテーションの最初のスライドからスライドショーが開始されます。" },
        { question: "アニメーションが設定された図形を選択し、[アニメーション]タブの「順番を前にする」を1回クリックすると、アニメーションの順番はどうなりますか。", options: ["順番が1つ早くなる", "順番が1つ遅くなる", "順番が最初になる"], answer: 0, explanation: "「順番を前にする」をクリックすると、選択したアニメーションの開始タイミングが1つ早くなります。" },
        { question: "すべてのスライドの同じ位置にスライド番号を表示するには、どこで設定するのが最も効率的ですか。", options: ["[ヘッダーとフッター]ダイアログボックス", "[スライドのサイズ]ダイアログボックス", "スライドマスター"], answer: 2, explanation: "スライドマスターでスライド番号のプレースホルダーの位置を調整すれば、すべてのスライドに一括で反映されます。" },
        { question: "[ヘッダーとフッター]で日付を自動更新にし、言語を「日本語」、カレンダーの種類を「和暦」にすると、どのように表示されますか。", options: ["3/14/2025", "2025年3月14日", "令和7年3月14日"], answer: 2, explanation: "設定に応じて、和暦での日付表示が可能です。" },
        { question: "[ホーム]タブの[リセット]ボタンをクリックすると、プレースホルダーのサイズや位置の変更をスライドマスターの既定の設定に戻せる。", options: ["正しい", "誤り"], answer: 0, explanation: "その通りです。個別のスライドに加えた書式やレイアウトの変更を、元のマスターの状態にリセットします。" },
        { question: "[デザイン]タブの[スライドのサイズ]で、選択したスライドのみ縦長のレイアウトに変更できる。", options: ["正しい", "誤り"], answer: 1, explanation: "スライドの向き（縦長/横長）はプレゼンテーション全体に適用され、特定のスライドだけを変更することはできません。" },
        { question: "[ホーム]タブの[新しいスライド]から[アウトラインからスライド]を選択し、メモ帳で作成したテキストファイルをスライドとして挿入できる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、テキストファイル内のインデント（字下げ）がスライドのタイトルとコンテンツのレベル分けに反映されます。" },
        { question: "[デザイン]タブの[背景の書式設定]で、すべてのスライドの背景を一括で変更できる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、[すべてに適用]ボタンをクリックすると、開いているプレゼンテーション内のすべてのスライドに背景設定が適用されます。" },
        { question: "ある図形のアニメーション設定をコピーし、他の複数の図形に連続して貼り付けるには、[アニメーションのコピー/貼り付け]ボタンをダブルクリックする。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。ダブルクリックすると、書式やアニメーションの連続コピーモードになり、複数のオブジェクトに次々と適用できます。" },
        { question: "スライドショーの[リハーサル]を開始した直後のツールバーで、左側の時間は「プレゼンテーション全体の所要時間」を表す。", options: ["正しい", "誤り"], answer: 1, explanation: "左側の時間は「現在表示しているスライドの表示時間」で、右側が「プレゼンテーション全体の経過時間」です。" },
        { question: "[オブジェクトの動作設定]で、オブジェクトのクリック時にPCにインストールされている特定のプログラムを起動するよう設定できる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、「プログラムの実行」を選択し、任意のアプリケーションを起動するようハイパーリンク設定が可能です。" },
        { question: "[ヘッダーとフッター]でフッターに「営業第2課」と入力し[すべてに適用]すると、タイトルスライドを含むすべてのスライドに表示される。", options: ["正しい", "誤り"], answer: 1, explanation: "通常、「タイトル スライドに表示しない」にチェックが入っているため、タイトルスライドには適用されません。チェックを外せば表示可能です。" },
        { question: "[ヘッダーとフッター]ダイアログボックスで、スライド番号をスライドの任意の位置に表示するよう設定できる。", options: ["正しい", "誤り"], answer: 1, explanation: "このダイアログボックスでは表示/非表示の切り替えのみです。位置の変更はスライドマスターで行います。" },
        { question: "[ヘッダーとフッター]の[ノートと配布資料]タブで、ヘッダーとフッターの両方を指定できる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、印刷するノートや配布資料の上部（ヘッダー）と下部（フッター）に、日付や任意のテキストを設定できます。" }
      ],
      "4. ファイル": [
        { question: "アウトライン表示でスライド2～4を選択している状態で、[印刷]設定で何を選択すればその3枚だけが印刷されますか。", options: ["[すべてのスライドを印刷]", "[選択した部分を印刷]", "[現在のスライドを印刷]"], answer: 1, explanation: "[選択した部分を印刷]は、選択されているスライドのみを印刷対象とします。" },
        { question: "[エクスポート]から作成したビデオに含まれないものはどれですか。", options: ["録音されたナレーション", "非表示に設定されたスライド", "画面切り替えのタイミング"], answer: 1, explanation: "非表示スライドは、通常の再生時にスキップされるため、ビデオとして書き出す際も含まれません。" },
        { question: "クラウド上でファイルを共有できるようにするには、ファイルをどこに保存しますか。", options: ["OneDriveに", "自分のコンピューター上に", "プレゼンテーションパックとして"], answer: 0, explanation: "OneDriveのようなクラウドストレージに保存することで、他者との共有や複数デバイスからのアクセスが容易になります。" },
        { question: "PowerPoint 2003以前のバージョンでファイルを開くには、ファイルの種類を何に設定して保存しますか。", options: ["PowerPoint プレゼンテーション (*.pptx)", "PowerPoint 97-2003 プレゼンテーション (*.ppt)", "PowerPoint テンプレート (*.potx)"], answer: 1, explanation: "古いバージョンとの互換性を保つためには、PowerPoint 97-2003 プレゼンテーション (*.ppt)形式で保存します。" },
        { question: "既存のプレゼンテーションファイルを編集中に上書き保存するショートカットキーはどれですか。", options: ["Ctrl + D", "Ctrl + F", "Ctrl + S"], answer: 2, explanation: "Ctrl + S は多くのアプリケーションで「上書き保存」のショートカットとして使われます。" },
        { question: "[ヘッダーとフッター]で日付を「自動更新」に設定して適用すると、スライドには何が表示されますか。", options: ["「2016/3/14」のまま", "ファイルを開いた際の日付", "最後に保存した日の日付"], answer: 1, explanation: "「自動更新」に設定すると、ファイルを開くたびにその時点の現在の日付に更新されます。" },
        { question: "印刷設定で部数を「2」以上に設定した際、1ページ目、2ページ目、3ページ目、その後再び1ページ目…と印刷するのは「ページ単位で印刷」である。", options: ["正しい", "誤り"], answer: 1, explanation: "この印刷方法は「部単位で印刷」です。「ページ単位で印刷」は、1ページ目を全部数分、次に2ページ目を全部数分…と印刷します。" },
        { question: "作成したファイルを常にスライドショー表示で開く形式として保存するには、ファイルの種類を「PowerPointスライドショー (*.ppsx)」に設定する。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。*.ppsx形式で保存すると、ファイルを開いたときに直接スライドショーが開始されます。" },
        { question: "[ファイル]タブの[閉じる]をクリックすると、PowerPointアプリケーションを終了せずに、現在のプレゼンテーションファイルだけを閉じることができる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、アプリケーションは起動したままで、作業中のファイルのみを閉じることができます。" },
        { question: "現在のプレゼンテーションをWordで編集可能な文書として保存するには、[ファイル]タブの[エクスポート]から[配布資料の作成]をクリックする。", options: ["正しい", "誤り"], answer: 0, explanation: "この操作により、スライドの画像とノートの内容をWord文書に変換して、配布資料を作成できます。" },
        { question: "離れたユーザーにオンライン上でスライドショーを閲覧してもらうには、[ファイル]タブの[共有]から電子メールを選択する。", options: ["正しい", "誤り"], answer: 1, explanation: "[共有]から[オンラインプレゼンテーション]を選択するのが適切な方法です。これにより、リアルタイムでスライドショーを共有できます。" }
      ],
      "5. 編集": [
        { question: "オブジェクトを垂直または水平方向にまっすぐコピーするには、どのキーを押しながらドラッグしますか。", options: ["CtrlキーとAltキー", "CtrlキーとShiftキー", "CtrlキーとTabキー"], answer: 1, explanation: "Ctrlキーでコピー、Shiftキーで移動方向を水平・垂直に固定します。両方を組み合わせることで、まっすぐコピーができます。" },
        { question: "複数のオブジェクトを同時に選択するには、1つ目を選択した後、どのキーを押しながら2つ目以降をクリックしますか。", options: ["Altキー", "Shiftキー", "Tabキー"], answer: 1, explanation: "Shiftキー（またはCtrlキー）を押しながらクリックすることで、オブジェクトを次々に追加選択できます。" },
        { question: "ある図形の色を変更した直後、別の図形を選択してF4キーを押すと、どうなりますか。", options: ["同じ色が設定される", "色は変わらない", "図形がコピーされる"], answer: 0, explanation: "F4キーには「直前の操作を繰り返す」機能があります。この場合、直前の「色の変更」が繰り返されます。" },
        { question: "テキスト「白い」を選択して「書式のコピー/貼り付け」ボタンを押し、その後「浜辺」をドラッグすると、どうなりますか。", options: ["「浜辺」に「白い」の書式が適用される", "「浜辺」が「白い」に置き換わる", "何も変わらない"], answer: 0, explanation: "「書式のコピー/貼り付け」は、文字そのものではなく、フォント、色、サイズなどの書式情報のみをコピーして適用する機能です。" },
        { question: "下線付きのテキストをコピーし、貼り付けオプションで「テキストのみ保持」を選択して貼り付けると、どうなりますか。", options: ["下線付きで貼り付けられる", "図として貼り付けられる", "下線なしのプレーンテキストとして貼り付けられる"], answer: 2, explanation: "「テキストのみ保持」を選択すると、コピー元の書式はすべて破棄され、貼り付け先の書式に準じたプレーンなテキストとして挿入されます。" },
        { question: "文字列「システム」を切り取った後、別の場所にカーソルを移動して「貼り付け」ボタンをクリックするとどうなりますか。", options: ["「システム」が貼り付けられる", "「ファイル」が削除される", "何も起こらない"], answer: 0, explanation: "切り取り(Ctrl+X)と貼り付け(Ctrl+V)の基本的な操作です。切り取った文字列がカーソル位置に挿入されます。" },
        { question: "[置換]ダイアログで「完全に一致する単語だけを検索する」にチェックを入れ、「A」を「a」に置換しようとすると、どうなりますか。", options: ["2個置換される", "3個置換される", "一致するものが見つからない"], answer: 2, explanation: "「完全に一致する単語」とは、前後にスペースなどがある独立した単語を指します。「Area」や「Apple」の中の'A'は対象外となるため、置換は行われません。" },
        { question: "3つの図形が選択された状態から、三角形の図形のみ選択を解除するには、Shiftキーを押しながら三角形をクリックする。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。Shiftキー（またはCtrlキー）を押しながら選択済みのオブジェクトをクリックすると、そのオブジェクトだけが選択解除されます。" },
        { question: "複数のオブジェクトがあるスライドで、1つを選択した状態でTabキーを押すと、オブジェクトの重なり順で1つ前面にあるオブジェクトが選択される。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、Tabキーでオブジェクトの選択を順番に切り替えることができます。重なり順は[ホーム]タブの[配置]>[オブジェクトの選択と表示]で確認・変更できます。" },
        { question: "[フォントの置換]機能を使うと、プレゼンテーション内の特定のフォントを、別のフォントに一括で置き換えることができる。", options: ["正しい", "誤り"], answer: 0, explanation: "その通りです。デザインの統一感を保ちたい場合や、特定のフォントが使えない環境でファイルを開く場合に便利な機能です。" }
      ],
      "6. 罫線と表": [
        { question: "表のセル内にカーソルがあるとき、[テーブルデザイン]タブの[塗りつぶし]ボタンを使用すると、どの範囲が塗りつぶされますか。", options: ["カーソルのあるセルのみ", "表内のすべてのセル", "どのセルも塗りつぶされない"], answer: 0, explanation: "セル内にカーソルがある場合、そのセルが対象となり塗りつぶされます。表全体を選択すれば、全体を塗りつぶせます。" },
        { question: "表のセル内で文字列を上下中央に配置するボタンはどれですか。", options: ["左右中央揃え", "右揃え", "上下中央揃え"], answer: 2, explanation: "[レイアウト]タブの[配置]グループにあるボタンで、セルの垂直方向の文字位置を調整します。" },
        { question: "マウスポインターが表の行の左側で右向き矢印の形になったときにクリックすると、何が選択されますか。", options: ["表全体", "その行全体", "その列全体"], answer: 1, explanation: "行の左側でクリックすると、その行全体が選択されます。" },
        { question: "[テーブルデザイン]タブでペンのスタイルや色を設定後、[罫線]ボタンから「格子」をクリックすると、選択したセルの格子状の罫線が変更される。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。事前に[罫線の作成]グループでデザインを定義し、[罫線]メニューから適用範囲を選ぶ、という手順です。" },
        { question: "表の列の境界線をダブルクリックすると、その列の幅が、列内の最も長い文字列に合わせて自動調整される。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、内容に最適な幅に素早く調整するための便利な機能です。" },
        { question: "「縞模様(行)」が設定されている表に行を挿入すると、新しく挿入された行は、上の行と同じ色のままになる。", options: ["正しい", "誤り"], answer: 1, explanation: "縞模様は自動的に再計算され、一行おきに色がつくパターンが維持されます。そのため、挿入された行は上下の行とは異なる色になります。" },
        { question: "文字列が入力されているセルを分割すると、文字列も分割されてそれぞれのセルに分配される。", options: ["正しい", "誤り"], answer: 1, explanation: "文字列は分割されません。列分割の場合は左のセルに、行分割の場合は上のセルに、元の文字列がすべて残ります。" },
        { question: "[レイアウト]タブの[セルの余白]から[広い]を選択すると、セル内の文字列と罫線の間の余白が広くなる。", options: ["正しい", "誤り"], answer: 0, explanation: "その通りです。セル内の余白を調整することで、表全体の見た目のゆとりをコントロールできます。" },
        { question: "マウスポインターが表の列の上で下向き矢印の形になったときにクリックすると、その列全体を選択できる。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。行は左側から、列は上側から選択するのが基本的な操作です。" }
      ],
      "7. オブジェクト": [
        { question: "2つの図形をグループ化した状態で[左右反転]を行うと、どのようになりますか。", options: ["グループ全体が1つのオブジェクトとして反転する", "それぞれの図形が個別に反転する", "何も変わらない"], answer: 0, explanation: "グループ化されたオブジェクトは単一のオブジェクトとして扱われるため、グループ全体がまとめて左右反転します。" },
        { question: "図形にテキストを追加し、[テキストに合わせて図形のサイズを調整する]オプションを選択するとどうなりますか。", options: ["自動調整されない", "はみ出す場合だけ文字が小さくなる", "入力したテキスト量に応じて図形の大きさが自動で変わる"], answer: 2, explanation: "このオプションは、テキストがすべて収まるように図形のサイズを自動的に拡大・縮小します。" },
        { question: "星形の図形にある黄色のハンドル（調整ハンドル）をドラッグするとどうなりますか。", options: ["星の先端が鋭くなる／丸くなる", "図形全体が拡大／縮小する", "図形が回転する"], answer: 0, explanation: "黄色の調整ハンドルは、図形の形状（角の丸み、先端の鋭さなど）を変化させるために使います。" },
        { question: "2つの図形を選択し、Ctrl+Gキーを押すとどうなりますか。", options: ["整列される", "グループ化される", "最背面へ移動する"], answer: 1, explanation: "Ctrl + G は、選択した複数のオブジェクトを1つのグループにまとめるショートカットキーです。" },
        { question: "テキストボックスと図形が重なっているとき、テキストボックスを最前面に表示するには[配置]から何を選択しますか。", options: ["[最前面へ移動]", "[最背面へ移動]", "[前面へ移動]"], answer: 0, explanation: "[最前面へ移動]を選ぶと、重なっているすべてのオブジェクトの中で一番手前に表示されます。" },
        { question: "画像の[サイズ]設定で「縦横比を固定する」のチェックを外し、「幅の倍率」のみを50%にすると、どうなりますか。", options: ["縦横比を保ったまま縮小する", "横方向にのみ縮小され、縦長の画像になる", "縦方向にのみ縮小され、横長の画像になる"], answer: 1, explanation: "「縦横比を固定する」のチェックを外すと、高さと幅を独立して変更できるため、画像は変形します。" },
        { question: "®や©のような特殊な記号を挿入するには、[挿入]タブのどのボタンを使用しますか。", options: ["[オンライン画像]", "[図形]", "[記号と特殊文字]"], answer: 2, explanation: "[記号と特殊文字]ダイアログボックスから、キーボードで直接入力できない様々な記号を挿入できます。" },
        { question: "ある図形に設定した独自の色を、別の図形に簡単に適用するには、どの機能を使いますか。", options: ["[スポイト]", "[グラデーション]", "[テクスチャ]"], answer: 0, explanation: "[スポイト]ツールを使うと、画面上の任意の色をクリックして抽出し、選択中の図形の塗りつぶし色として設定できます。" },
        { question: "売上実績を商品別に月次比較するグラフとして最も適しているのは「集合縦棒グラフ」である。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、集合縦棒グラフは、項目ごとの数値を時系列やカテゴリで比較するのに非常に適しています。" },
        { question: "SmartArtグラフィックのレイアウトは、作成後に[SmartArtのデザイン]タブから別の種類に変更できる。", options: ["正しい", "誤り"], answer: 0, explanation: "正しいです。テキスト内容は維持したまま、様々なレイアウトに切り替えて、最適な表現を探すことができます。" },
        { question: "グループ化されたオブジェクトの一部（中央の円など）だけを、グループ化を解除せずに削除することはできる。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、グループ内の個別のオブジェクトをクリックして選択（サブ選択）すれば、そのオブジェクトだけを編集・削除できます。" },
        { question: "画像の[トリミング]を行うと、画像の不要な部分が見えなくなるだけで、データとしては残っている。", options: ["正しい", "誤り"], answer: 1, explanation: "トリミングは画像の不要な部分を非表示にする機能です。PowerPoint 2010以降では、トリミング後も元画像の情報は保持されており、後から再編集が可能です。（[図の圧縮]で「図のトリミング部分を削除する」をオンにすると完全に削除されます）" },
        { question: "スライドに挿入されたグラフの元データを編集するには、[グラフのデザイン]タブの[データの編集]ボタンをクリックする。", options: ["正しい", "誤り"], answer: 0, explanation: "その通りです。このボタンをクリックすると、グラフの元データとなっているExcelのワークシートが表示され、数値を編集できます。" },
        { question: "図形の角のハンドルをAltキーを押しながらドラッグすると、縦横の比率を保ったまま拡大/縮小できる。", options: ["正しい", "誤り"], answer: 1, explanation: "縦横比を保ったまま拡大/縮小するには、Shiftキーを押しながらドラッグします。" },
        { question: "JPEG形式の画像には、[図の形式]タブの[アート効果]から「ペイント:描線」のような効果を設定できない。", options: ["正しい", "誤り"], answer: 1, explanation: "設定できます。JPEGやPNGなどの一般的な画像形式であれば、様々なアート効果を適用して、絵画やスケッチのような風合いに加工できます。" },
        { question: "SmartArtグラフィックで、図形の左右の配置を入れ替えるには、[SmartArtのデザイン]タブの[右から左]ボタンを使用する。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、このボタンはフローやプロセスの方向をワンクリックで反転させたい場合に便利です。" },
        { question: "横書きのテキストボックスを縦書きに変更するには、[図形の書式]タブの[配置]ボタンを使用する。", options: ["正しい", "誤り"], answer: 1, explanation: "文字列の方向を変更するには、[ホーム]タブの[段落]グループにある[文字列の方向]ボタンを使用します。" }
      ],
      "8. 校閲": [
        { question: "スライド上に表示される吹き出しのアイコンは、何が挿入されていることを表していますか。", options: ["コメント", "テキストボックス", "代替テキスト"], answer: 0, explanation: "このアイコンは、その箇所にコメントが追加されていることを示します。共同作業時のフィードバックなどに使われます。" },
        { question: "[校閲]タブの[スペルチェック]ボタンをクリックすると、どの文字列に対してチェックが行われますか。", options: ["全角の文字列", "すべての文字列", "半角英数字"], answer: 1, explanation: "プレゼンテーション内のすべてのテキスト（半角英数字のスペルと、日本語の文章校正）が対象となります。" },
        { question: "[校閲]タブの[比較]ボタンで別のプレゼンテーションファイルを開くと、何ができますか。", options: ["2つのプレゼンテーションウィンドウを並べて表示する", "変更履歴を確認しながら、修正を反映する", "変更箇所だけを抜き出して表示させる"], answer: 1, explanation: "比較機能は、元のファイルと修正後のファイルの差分を検出し、変更箇所を一つずつ確認しながら、修正を取り込むかどうかを決定できる機能です。" },
        { question: "[校閲]タブの[コメントの表示]ボタンを使用して、コメントの表示/非表示を切り替えることができる。", options: ["正しい", "誤り"], answer: 1, explanation: "コメントの表示/非表示は、個別のコメントを閉じるか、[コメント]作業ウィンドウの表示/非表示で行います。[コメントの表示]ボタンは、コメントのナビゲーション（次へ、前へ）に使われることが多いです。" },
        { question: "[校閲]タブの[スペルチェック]ボタンをクリックすると、現在表示しているスライド内のテキストに対してのみ、チェックが実行される。", options: ["正しい", "誤り"], answer: 1, explanation: "スペルチェックは、特に範囲を指定しない限り、プレゼンテーション全体（すべてのスライド、ノート、アウトライン）を対象とします。" },
        { question: "プレゼンテーションを比較した際、変更があった箇所に変更履歴のアイコンが表示される。", options: ["正しい", "誤り"], answer: 0, explanation: "はい、スライド上の変更されたオブジェクトの近くに、変更内容の詳細を示すアイコンが表示されます。" }
      ]
    };
    
    // --- STATE MANAGEMENT ---
    let currentQuiz = [], currentIndex = 0, wrongAnswers = [], selectedChapter = "";
    let userId = null;
    let geminiApiKey = null;
    let weeklyChart = null;

    // --- INITIALIZATION ---
    window.onload = () => {
      initializeUser();
      loadApiKey();
      renderHomePage();
    };

    function initializeUser() {
      userId = localStorage.getItem('quiz_userId');
      if (!userId) {
        userId = crypto.randomUUID();
        localStorage.setItem('quiz_userId', userId);
      }
      document.getElementById('userIdFooter').textContent = `学習ID: ${userId}`;
    }

    function loadApiKey() {
      geminiApiKey = localStorage.getItem('gemini_apiKey');
    }

    // --- RENDERING ---
    function renderHomePage() {
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-800">PowerPoint 上級知識問題集</h2>
          <button onclick="showApiKeyDialog()" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded-full">⚙️ 設定</button>
        </div>
        
        <!-- Dashboard -->
        <details class="mb-4" open>
          <summary class="text-lg font-bold text-gray-700 cursor-pointer p-2 rounded-lg hover:bg-gray-100">学習ダッシュボード</summary>
          <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div id="calendar-container" class="p-4 bg-gray-50 rounded-lg"></div>
              <div class="p-4 bg-gray-50 rounded-lg">
                  <canvas id="weeklyChart"></canvas>
              </div>
          </div>
        </details>
        <hr>
        
        <!-- Quiz Start -->
        <div>
            <h3 class="text-lg font-bold text-gray-700 mb-2">クイズに挑戦</h3>
            <select id="chapterSelect" class="bg-gray-50 border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
            <select id="questionCount" class="bg-gray-50 border border-gray-300 rounded-md p-2 w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="5">5問</option>
              <option value="10" selected>10問</option>
              <option value="all">全問</option>
            </select>
            <button onclick="startQuiz()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">この章でクイズを始める</button>
            <button onclick="showHistoryList()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">学習履歴を見る</button>
        </div>
        <hr>

        <!-- AI Features -->
        <div>
            <h3 class="text-lg font-bold text-gray-700 mb-2">AI サポート機能</h3>
            <button onclick="askAITeacher()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg">AI先生に質問する ✨</button>
            <button onclick="showStudyPlan()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">今日の学習プランを立てる ✨</button>
        </div>
      `;
      
      const chapterSelect = document.getElementById("chapterSelect");
      chapterSelect.innerHTML = `<option value="">章を選択してください</option>`;
      Object.keys(chapters).forEach(ch => {
        const opt = document.createElement("option");
        opt.value = ch;
        opt.textContent = ch;
        chapterSelect.appendChild(opt);
      });

      renderDashboard();
    }
    
    function renderDashboard() {
        renderCalendar();
        renderWeeklyChart();
    }

    function renderCalendar() {
        const container = document.getElementById('calendar-container');
        const history = getHistory();
        const studiedDates = history.map(record => new Date(record.date).toDateString());
        
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let html = `<h4 class="font-bold text-center mb-2">${year}年 ${month + 1}月</h4>
                    <table id="calendar" class="w-full"><thead><tr>`;
        const days = ['日', '月', '火', '水', '木', '金', '土'];
        days.forEach(day => html += `<th>${day}</th>`);
        html += `</tr></thead><tbody><tr>`;

        for (let i = 0; i < firstDay.getDay(); i++) {
            html += `<td></td>`;
        }

        for (let day = 1; day <= lastDay.getDate(); day++) {
            const currentDate = new Date(year, month, day);
            if (currentDate.getDay() === 0 && day !== 1) {
                html += `</tr><tr>`;
            }
            const dateStr = currentDate.toDateString();
            let classes = [];
            if (dateStr === new Date().toDateString()) classes.push('today');
            if (studiedDates.includes(dateStr)) classes.push('studied');
            
            html += `<td class="${classes.join(' ')}">${day}</td>`;
        }
        
        html += `</tr></tbody></table>`;
        container.innerHTML = html;
    }

    function renderWeeklyChart() {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        const history = getHistory();
        const labels = [];
        const data = [];
        
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
            
            const solvedCount = history
                .filter(record => new Date(record.date).toDateString() === d.toDateString())
                .reduce((sum, record) => sum + record.total, 0);
            data.push(solvedCount);
        }
        
        if(weeklyChart) weeklyChart.destroy();

        weeklyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '解いた問題数',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: '週間学習グラフ'
                    }
                }
            }
        });
    }

    // --- QUIZ LOGIC ---
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function startQuiz() {
      const chapter = document.getElementById("chapterSelect").value;
      const count = document.getElementById("questionCount").value;
      if (!chapter) {
        showMessageDialog("エラー", "学習したい章を選択してください。");
        return;
      }
      selectedChapter = chapter;
      let questions = shuffle([...chapters[chapter]]);
      if (count !== "all") {
        questions = questions.slice(0, parseInt(count));
      }
      currentQuiz = questions;
      currentIndex = 0;
      wrongAnswers = [];
      showQuestion();
    }

    function showQuestion() {
      const q = currentQuiz[currentIndex];
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="mb-4">
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-xl font-bold text-blue-600">問題 ${currentIndex + 1} / ${currentQuiz.length}</h3>
            <div class="text-sm font-semibold text-gray-600">${selectedChapter}</div>
          </div>
          <div class="p-4 bg-gray-100 rounded-lg">
            <p class="text-gray-800">${q.question}</p>
          </div>
        </div>`;
      
      q.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.innerHTML = `<span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center mr-3">${i === 0 ? 'ア' : i === 1 ? 'イ' : 'ウ'}</span> ${opt}`;
        btn.onclick = () => checkAnswer(i);
        btn.className = "bg-white hover:bg-blue-50 border border-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg my-1 w-full text-left flex items-center transition-colors duration-200";
        app.appendChild(btn);
      });
    }

    function checkAnswer(selected) {
      const q = currentQuiz[currentIndex];
      if (selected !== q.answer) {
        wrongAnswers.push({ question: q.question, answer: q.options[q.answer], explanation: q.explanation });
      }
      showResult(selected, q);
    }

    function showResult(selected, q) {
      const app = document.getElementById("app");
      const isCorrect = selected === q.answer;
      app.innerHTML = "";
      const resultDiv = document.createElement("div");
      resultDiv.className = `p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;
      resultDiv.innerHTML = `
        <h3 class="text-2xl font-bold mb-2 ${isCorrect ? 'text-green-700' : 'text-red-700'}">${isCorrect ? '✅ 正解！' : '❌ 不正解...'}</h3>
        <p class="font-semibold text-gray-700 mb-2">正解は「${q.options[q.answer]}」です。</p>
        <p class="text-gray-600">${q.explanation}</p>
      `;
      app.appendChild(resultDiv);

      const nextBtn = document.createElement("button");
      nextBtn.textContent = currentIndex < currentQuiz.length - 1 ? "次の問題へ" : "結果を見る";
      nextBtn.onclick = nextQuestion;
      nextBtn.className = "bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg my-4 w-full";
      app.appendChild(nextBtn);
    }

    function nextQuestion() {
      currentIndex++;
      if (currentIndex < currentQuiz.length) {
        showQuestion();
      } else {
        saveHistory();
        showFinalScore();
      }
    }

    function showFinalScore() {
      const app = document.getElementById("app");
      const correctCount = currentQuiz.length - wrongAnswers.length;
      const totalCount = currentQuiz.length;
      const score = Math.round((correctCount / totalCount) * 100);

      app.innerHTML = `
        <div class="text-center">
            <h2 class="text-2xl font-bold mb-2">クイズ終了！</h2>
            <p class="text-lg text-gray-700 mb-4">${selectedChapter}</p>
            <p class="text-4xl font-bold mb-2">${correctCount} <span class="text-2xl font-normal">/ ${totalCount} 問正解</span></p>
            <p class="text-5xl font-bold text-blue-600 mb-6">${score}<span class="text-3xl">%</span></p>
        </div>
        <hr>`;

      const reviewBtn = document.createElement("button");
      reviewBtn.textContent = "間違えた問題を復習する";
      reviewBtn.onclick = () => showWrongAnswers(wrongAnswers, showFinalScore);
      reviewBtn.disabled = wrongAnswers.length === 0;
       if (wrongAnswers.length === 0) {
        reviewBtn.textContent = "全問正解です！素晴らしい！";
      }
      reviewBtn.className = "bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg w-full";
      app.appendChild(reviewBtn);

      const backBtn = document.createElement("button");
      backBtn.textContent = "ホームに戻る";
      backBtn.onclick = renderHomePage;
      backBtn.className = "bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg w-full";
      app.appendChild(backBtn);
    }
    
    // --- HISTORY MANAGEMENT ---
    function getHistory() {
        return JSON.parse(localStorage.getItem(`quiz_history_${userId}`) || "[]");
    }

    function saveHistory() {
      const newRecord = {
        date: new Date().toISOString(),
        chapter: selectedChapter,
        correct: currentQuiz.length - wrongAnswers.length,
        total: currentQuiz.length,
        wrong: wrongAnswers,
      };
      let history = getHistory();
      history.unshift(newRecord); 
      localStorage.setItem(`quiz_history_${userId}`, JSON.stringify(history.slice(0, 50))); 
    }

    function showHistoryList() {
      const history = getHistory();
      const app = document.getElementById("app");
      app.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">📚 学習履歴</h2>
            <button onclick="resetHistory()" class="text-sm bg-red-100 hover:bg-red-200 text-red-700 font-bold py-1 px-3 rounded-full">履歴をリセット</button>
        </div>`;
      if (history.length === 0) {
        app.innerHTML += `<p class="text-gray-600 text-center">まだ学習履歴がありません。</p>`;
      } else {
        history.forEach((record, i) => {
          const rate = Math.round((record.correct / record.total) * 100);
          const div = document.createElement("div");
          div.className = "p-4 bg-gray-50 rounded-lg mb-4";
          div.innerHTML = `
            <p class="font-semibold">${record.chapter}</p>
            <p class="text-sm text-gray-500">${new Date(record.date).toLocaleString('ja-JP')}</p>
            <p class="my-2">正解率: <span class="font-bold ${rate > 80 ? 'text-green-600' : 'text-yellow-600'}">${rate}%</span> (${record.correct}/${record.total}問)</p>
            <div class="h-2 bg-gray-200 rounded-full my-2">
              <div class="h-full bg-blue-500 rounded-full" style="width:${rate}%;"></div>
            </div>`;
          
          if (record.wrong.length > 0) {
            const reviewBtn = document.createElement("button");
            reviewBtn.textContent = `間違えた${record.wrong.length}問を復習`;
            reviewBtn.onclick = () => showWrongAnswers(record.wrong, showHistoryList);
            reviewBtn.className = "bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg mt-2 w-full text-sm";
            div.appendChild(reviewBtn);
          }
          app.appendChild(div);
        });
      }
      const backBtn = document.createElement("button");
      backBtn.textContent = "ホームに戻る";
      backBtn.onclick = renderHomePage;
      backBtn.className = "bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-4 w-full";
      app.appendChild(backBtn);
    }
    
    function resetHistory() {
        if (confirm("本当にすべての学習履歴をリセットしますか？この操作は元に戻せません。")) {
            localStorage.removeItem(`quiz_history_${userId}`);
            showHistoryList();
        }
    }

    function showWrongAnswers(wrongQuestions, backFunction) {
      const app = document.getElementById("app");
      app.innerHTML = `<h2 class="text-xl font-bold mb-4">🔁 間違えた問題の復習</h2><hr>`;
      wrongQuestions.forEach((q, i) => {
        const div = document.createElement("div");
        div.className = "p-4 bg-gray-50 rounded-lg mb-4 border-l-4 border-yellow-500";
        div.innerHTML = `<p class="font-bold text-gray-800">Q: ${q.question}</p>
                         <p class="mt-2 text-green-700">✅ 正解: ${q.answer}</p>
                         <p class="mt-1 text-gray-600">📘 解説: ${q.explanation}</p>`;
        app.appendChild(div);
      });

      const backBtn = document.createElement("button");
      backBtn.textContent = "戻る";
      backBtn.onclick = backFunction;
      backBtn.className = "bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-4 w-full";
      app.appendChild(backBtn);
    }
    
    // --- API & AI FEATURES ---
    async function callGeminiAPI(prompt, systemInstruction = null) {
      if (!geminiApiKey) {
        throw new Error("API_KEY_NOT_SET");
      }
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        ...(systemInstruction && { systemInstruction: { parts: [{ text: systemInstruction }] } }),
      };

      let response;
      const maxRetries = 5;
      const retryableStatuses = [429, 503, 504];

      for (let i = 0; i < maxRetries; i++) {
        try {
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            break;
          }
          
          if (!retryableStatuses.includes(response.status)) {
             break;
          }
          
          const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
          console.log(`API call failed with status ${response.status}. Retrying in ${delay.toFixed(0)}ms...`);
          await new Promise(resolve => setTimeout(resolve, delay));
          
        } catch (error) {
          console.error("Fetch error:", error);
          if (i === maxRetries - 1) {
             throw error;
          }
          const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
          console.log(`Network error. Retrying in ${delay.toFixed(0)}ms...`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }

      if (!response.ok) {
        throw new Error(`API call failed with status: ${response.status}`);
      }
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || "応答がありませんでした。";
    }

    async function askAITeacher() {
        if (!geminiApiKey) {
            showApiKeyDialog("AI先生を利用するにはAPIキーの設定が必要です。");
            return;
        }
      const app = document.getElementById("app");
      app.innerHTML = `
        <h2 class="text-xl font-bold mb-4">AI先生に質問する ✨</h2>
        <p class="text-gray-600 mb-4">PowerPointに関する質問や、間違えた問題について、AI先生に質問してみましょう。</p>
        <textarea id="aiQuestion" class="w-full h-32 p-2 border border-gray-300 rounded-lg my-4 focus:ring-2 focus:ring-blue-500" placeholder="例：スライドマスターの具体的な活用方法について、もっと詳しく教えてください。"></textarea>
        <button id="sendQuestionBtn" onclick="sendAITeacherQuestion()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg w-full">質問を送信する</button>
        <button onclick="renderHomePage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-2 w-full">ホームに戻る</button>
      `;

      const history = getHistory();
      if (history.length > 0 && history[0].wrong.length > 0) {
        const latestWrong = history[0].wrong;
        const wrongQuestionText = latestWrong.map(q => `- 「${q.question}」`).join('\n');
        const placeholder = `AI先生、前回のクイズで間違えた以下の問題について、もっと分かりやすく解説してください。\n\n${wrongQuestionText}`;
        document.getElementById('aiQuestion').value = placeholder;
      }
    }

    async function sendAITeacherQuestion() {
      const question = document.getElementById("aiQuestion").value;
      if (!question) {
        showMessageDialog("エラー", "質問内容を入力してください。");
        return;
      }

      showLoadingDialog("AI先生が回答を作成中です...");
      const systemPrompt = "あなたはMicrosoft PowerPointの操作と知識に非常に詳しいエキスパートであり、親切な家庭教師です。ユーザーからの質問に対して、専門用語を避け、初心者にも理解できるように具体的で分かりやすい言葉で回答してください。";
      try {
        const response = await callGeminiAPI(question, systemPrompt);
        showMessageDialog("AI先生からの回答", response);
      } catch (e) {
        handleApiError(e);
      }
    }
    
    async function showStudyPlan() {
        if (!geminiApiKey) {
            showApiKeyDialog("学習プランの作成にはAPIキーの設定が必要です。");
            return;
        }
      showLoadingDialog("あなたのための学習プランを作成中です...");
      
      const history = getHistory();
      const wrongQuestionsText = history.slice(0, 5).flatMap(r => r.wrong.map(q => q.question)).join('\n');
      
      let prompt;
      if (wrongQuestionsText.length > 0) {
        prompt = `ユーザーの直近の不正解問題のリストです：\n${wrongQuestionsText}\n\nこれらの傾向を分析し、このユーザーが次に重点的に学習すべきポイントを3つ挙げてください。そして、それぞれのポイントについて、具体的な学習アクションを提案し、励ましの言葉を添えた学習プランを作成してください。`;
      } else {
        prompt = `ユーザーはまだクイズに挑戦していないか、全問正解しています。PowerPointのスキルをさらに向上させるための、中級者から上級者向けの学習プランを提案してください。重点ポイントを3つ挙げ、それぞれ具体的なアクションを提案してください。`;
      }

      const systemPrompt = "あなたは優秀な学習コンサルタントです。ユーザーの学習履歴（特に苦手な分野）を基に、モチベーションが上がるような、パーソナライズされた学習プランを提案してください。箇条書きを使い、簡潔で分かりやすい言葉で記述してください。";

      try {
        const response = await callGeminiAPI(prompt, systemPrompt);
        showMessageDialog("今日の学習プラン提案 ✨", response);
      } catch (e) {
        handleApiError(e);
      }
    }
    
    // --- UTILITIES & DIALOGS ---
    function showApiKeyDialog(message = "") {
        const messageHtml = message ? `<p class="text-sm text-red-600 bg-red-100 p-2 rounded-md mb-4">${message}</p>` : "";
        let dialogContainer = document.querySelector('.dialog-container');
        if (dialogContainer) dialogContainer.remove();
        
        dialogContainer = document.createElement('div');
        dialogContainer.className = 'dialog-container';
        
        const dialog = document.createElement('div');
        dialog.className = 'dialog';
        dialog.innerHTML = `
            <h3 class="text-xl font-bold mb-2">APIキー設定</h3>
            ${messageHtml}
            <p class="text-sm text-gray-600 mb-4">AI機能（AI先生、学習プラン）を利用するには、Google AI Studioで取得したGemini APIキーが必要です。</p>
            <input type="password" id="apiKeyInput" class="w-full p-2 border border-gray-300 rounded-md" placeholder="APIキーを入力...">
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sm text-blue-600 hover:underline">APIキーの取得はこちら</a>
            <button onclick="saveApiKey()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 w-full">保存する</button>
            <button onclick="this.parentElement.parentElement.remove()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg w-full">閉じる</button>`;
        
        dialog.querySelector('#apiKeyInput').value = geminiApiKey || '';
        dialogContainer.appendChild(dialog);
        document.body.appendChild(dialogContainer);
    }
    
    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value;
        if (key) {
            localStorage.setItem('gemini_apiKey', key);
            geminiApiKey = key;
            document.querySelector('.dialog-container')?.remove();
            showMessageDialog("成功", "APIキーを保存しました。");
        } else {
            localStorage.removeItem('gemini_apiKey');
            geminiApiKey = null;
            showMessageDialog("情報", "APIキーを削除しました。");
        }
    }
    
    function handleApiError(error) {
        if (error.message === "API_KEY_NOT_SET") {
            showApiKeyDialog("AI機能を利用するにはAPIキーの設定が必要です。");
        } else {
            console.error(error);
            showMessageDialog("エラー", "AIとの通信中にエラーが発生しました。APIキーが正しいか、ネットワーク接続を確認してください。");
        }
    }
    
    function showMessageDialog(title, content) {
      let dialogContainer = document.querySelector('.dialog-container');
      if (dialogContainer) dialogContainer.remove();
      
      dialogContainer = document.createElement('div');
      dialogContainer.className = 'dialog-container';
      
      const dialog = document.createElement('div');
      dialog.className = 'dialog';
      dialog.innerHTML = `<h3 class="text-xl font-bold mb-4">${title}</h3>
        <div class="text-gray-700 whitespace-pre-wrap">${content.replace(/\n/g, '<br>')}</div>
        <button onclick="this.parentElement.parentElement.remove()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mt-6 w-full">閉じる</button>`;
      
      dialogContainer.appendChild(dialog);
      document.body.appendChild(dialogContainer);
    }

    function showLoadingDialog(title) {
       let dialogContainer = document.querySelector('.dialog-container');
      if (dialogContainer) dialogContainer.remove();
      
      dialogContainer = document.createElement('div');
      dialogContainer.className = 'dialog-container';
      
      const dialog = document.createElement('div');
      dialog.className = 'dialog flex flex-col items-center';
      dialog.innerHTML = `<h3 class="text-xl font-bold mb-4">${title}</h3><div class="spinner"></div>`;
      
      dialogContainer.appendChild(dialog);
      document.body.appendChild(dialogContainer);
    }

  </script>
</body>
</html>
